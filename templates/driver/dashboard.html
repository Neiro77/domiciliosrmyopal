{% extends 'base.html' %}

{% block title %}Dashboard de Conductor{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-8">
	<div id="bell" class="notification-bell hidden">
		ðŸ”” Pedido nuevo
		<span id="bell" class="bell">ðŸ””</span>
	</div>


    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800">Hola, {{ driver_profile.first_name }}</h1>
                <p class="text-gray-600">AquÃ­ estÃ¡n tus entregas asignadas.</p>
            </div>
            <div class="text-center">
                <p class="text-sm text-gray-500">Saldo Actual</p>
                <p class="text-2xl font-bold text-green-600">${{ "%.2f"|format(driver_profile.saldo_cuenta) }}</p>
                <a href="{{ url_for('driver.recharge_balance') }}" class="text-sm text-blue-600 hover:underline">Recargar</a>
            </div>
            <div class="flex items-center gap-4 p-4 border border-gray-200 rounded-lg">
                <p class="font-semibold">Mi estado:</p>
                {% if driver_profile.is_available %}
                    <span class="px-3 py-1 bg-green-200 text-green-800 rounded-full font-semibold">Disponible</span>
                {% else %}
                    <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full font-semibold">No Disponible</span>
                {% endif %}
                <form action="{{ url_for('driver.toggle_availability') }}" method="POST">
					<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg shadow-md transition duration-300 text-sm">Cambiar</button>
                </form>
            </div>
        </div>
    </div>
    
    <h2 class="text-2xl font-bold text-gray-700 mb-6">Mis Entregas Activas</h2>

    {% if orders %}
        <div class="space-y-6">
        {% for order in orders %}
            <div class="bg-white rounded-lg shadow-xl overflow-hidden" x-data="{ detailsOpen: false }">
                <div class="bg-gray-50 p-4 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Pedido #{{ order.id }} - <span class="text-blue-600">{{ order.service.name | capitalize }}</span></h3>
                        <p class="text-sm text-gray-500">Cliente: {{ order.user.customer_profile.first_name }}</p>
                    </div>
                    <span class="text-sm font-semibold px-3 py-1 rounded-full
                        {% if order.status == 'Aceptado' %} bg-blue-200 text-blue-800
                        {% elif order.status == 'En Camino' %} bg-orange-200 text-orange-800
                        {% else %} bg-gray-200 text-gray-800 {% endif %}">
                        {{ order.status }}
                    </span>
                </div>

                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-2"><i class="fas fa-box-open mr-2"></i>Recoger en:</h4>
                            <p class="text-gray-800">{{ order.pickup_address or 'No especificada' }}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2"><i class="fas fa-map-marker-alt mr-2"></i>Entregar a:</h4>
                            <p class="text-gray-800">{{ order.delivery_address }}</p>
                        </div>
                    </div>
                    
                    <button @click="detailsOpen = !detailsOpen" class="w-full text-left text-blue-600 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">
                        <span x-show="!detailsOpen"><i class="fas fa-chevron-down mr-2"></i>Mostrar Detalles del Contenido</span>
                        <span x-show="detailsOpen"><i class="fas fa-chevron-up mr-2"></i>Ocultar Detalles</span>
                    </button>

                    <div x-show="detailsOpen" x-transition class="mt-4 border-t pt-4">
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                        {% for item in order.items %}
                            {% if item.tipo_item == 'producto_comida' and item.product %}
                                <li>{{ item.quantity }} x <strong>{{ item.product.name }}</strong></li>
                            {% elif item.tipo_item == 'paquete_envio' and item.paquete_envio %}
                                <li>
                                    <strong>Paquete: {{ item.paquete_envio.tipo_paquete | capitalize }}</strong>
                                    <ul class="list-inside list-disc ml-4 text-sm">
                                        <li><strong>Desc:</strong> {{ item.paquete_envio.descripcion }}</li>
                                        <li><strong>Peso:</strong> {{ item.paquete_envio.peso_kg }} kg</li>
                                        <li><strong>Instrucciones:</strong> {{ item.paquete_envio.instrucciones_especiales or 'Ninguna' }}</li>
                                    </ul>
                                </li>
                            {% endif %}
                        {% endfor %}
                        </ul>
                    </div>
                </div>
					
				<div class="mt-6 flex flex-col sm:flex-row items-center gap-4">

				  {% if order.status == OrderStatus.ACCEPTED.value %}
					<form method="POST"
						  action="{{ url_for('driver.update_delivery_status', order_id=order.id) }}">
					  {{ form.hidden_tag() }}
					  <input type="hidden" name="new_status" value="{{ OrderStatus.OUT_FOR_DELIVERY.value }}">
					  <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
						Marcar en camino
					  </button>
					</form>

				  {% elif order.status == OrderStatus.OUT_FOR_DELIVERY.value %}
					<form method="POST"
						  action="{{ url_for('driver.update_delivery_status', order_id=order.id) }}">
					  {{ form.hidden_tag() }}
					  <input type="hidden" name="new_status" value="{{ OrderStatus.DELIVERED.value }}">
					  <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
						Marcar entregado
					  </button>
					</form>
				  {% endif %}

				</div>

				
                <!-- </div> -->
            </div>
        {% endfor %}
        </div>
    {% else %}
        <div class="text-center text-gray-600 text-lg py-16 border-2 border-dashed border-gray-300 rounded-lg">
            <i class="fas fa-motorcycle text-6xl text-gray-400 mb-4"></i>
            <p class="font-semibold">Â¡Todo listo para rodar!</p>
            <p>No tienes entregas asignadas en este momento.</p>
        </div>
    {% endif %}
	
	{% if active_order %}
	  <div class="alert alert-info">
		Tienes un pedido en curso. Completa este domicilio para aceptar otro.
	  </div>
	{% else %}	
		{% if available_orders and not active_order %}
		<div id="available-orders" class="card mt-4">
		  <div class="card-header">
			<strong>Domicilios disponibles</strong>
		  </div>
		  <div class="card-body">
			{% for order in available_orders %}
			  <div class="border rounded p-2 mb-2">
				<p><strong>Pedido #{{ order.id }}</strong></p>
				<p>DirecciÃ³n: {{ order.address }}</p>

				<form method="POST"
					  action="{{ url_for('driver.accept_order', order_id=order.id) }}"
					  onsubmit="this.querySelector('button').disabled=true;
								this.querySelector('button').innerText='Asignandoâ€¦';">

				  {{ form.hidden_tag() }}

				  <button type="submit" class="btn btn-success">
					Aceptar pedido
				  </button>
				</form>

			  </div>
			{% endfor %}
		  </div>
		</div>
		{% endif %}
	
	{% endif %}

</div>

{% if not active_order %}
  <div id="notification-bell" style="display:none;">
    ðŸ”” Nuevo pedido disponible
	<span id="notif-count" class="badge hidden">0</span>
  </div>

  <audio id="notification-sound" preload="auto">
    <source src="{{ url_for('static', filename='sounds/alerta_virus.mp3') }}" type="audio/mpeg">
  </audio>
{% endif %}

<script>
function playSound() {
    const audio = document.getElementById("notification-sound");
    audio.currentTime = 0;
    audio.play().catch(() => {});
}

function triggerBell() {
    document.getElementById("bell").classList.remove("hidden");
}
</script>


{% if not active_order %}
<script>
  const STORAGE_KEY = "hadAvailableOrders";
  let hadAvailableOrders = sessionStorage.getItem(STORAGE_KEY) === "true";

  async function checkAvailableOrders() {
    try {
      const res = await fetch("{{ url_for('driver.dashboard') }}", {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      const html = await res.text();
      const hasOrdersNow = html.includes('id="available-orders"');

      if (hasOrdersNow && !hadAvailableOrders) {
        document.getElementById("notification-sound")?.play().catch(()=>{});
      }

      sessionStorage.setItem(STORAGE_KEY, hasOrdersNow);
      hadAvailableOrders = hasOrdersNow;
    } catch {}
  }

  setInterval(checkAvailableOrders, 10000);
</script>
{% endif %}

<script>
  const audio = new Audio("/static/sounds/alerta_virus.mp3");
  
  let lastPendingCount = Number(localStorage.getItem("lastPendingCount")) || 0;

  function checkNotifications() {
    fetch("/driver/notifications")
      .then(res => res.json())
      .then(data => {
        const badge = document.getElementById("notif-count");

		if (currentCount > 0) {
		  badge.textContent = currentCount;
		  badge.classList.remove("hidden");
		} else {
		  badge.classList.add("hidden");
		}

      })
      .catch(err => console.error("Notif error:", err));
  }

  // primera ejecuciÃ³n
  checkNotifications();

  // polling cada 10s
  setInterval(checkNotifications, 15000);

  localStorage.setItem("lastPendingCount", currentCount);
</script>

<script>
let lastNotification = null;

setInterval(async () => {
  const res = await fetch('/driver/notifications');
  const data = await res.json();

  if (data.has_new && data.order_id !== lastNotification) {
    document.getElementById('bell').classList.add('active');
    document.getElementById('alertSound').play();
    lastNotification = data.order_id;
  }
}, 8000);

if (data.driver_available === false) {
  return; // no sonido, no campana
}
</script>




{% endblock %}