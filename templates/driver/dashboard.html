{% extends 'base.html' %}
{% block title %}Dashboard de Conductor{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

<!-- ðŸ”” CAMPANA -->
<div id="driverBell" class="fixed top-20 right-4 z-50 hidden">
  <div class="relative bg-yellow-400 p-3 rounded-full shadow-lg animate-bounce">
    ðŸ””
    <span id="driverBellCount"
          class="absolute -top-2 -right-2 bg-red-600 text-white
                 text-xs font-bold px-2 py-0.5 rounded-full">
      1
    </span>
  </div>
</div>

<!-- ðŸ”Š SONIDO -->
<audio id="driverSound" preload="auto">
  <source src="{{ url_for('static', filename='sounds/alerta_virus.mp3') }}" type="audio/mpeg">
</audio>

<!-- HEADER -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-8">
  <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
    <div>
      <h1 class="text-3xl font-extrabold text-gray-800">
        Hola, {{ driver_profile.first_name }}
      </h1>
      <p class="text-gray-600">AquÃ­ estÃ¡n tus entregas asignadas.</p>
    </div>

    <div class="text-center">
      <p class="text-sm text-gray-500">Saldo Actual</p>
      <p class="text-2xl font-bold text-green-600">
        ${{ "%.2f"|format(driver_profile.saldo_cuenta) }}
      </p>
      <a href="{{ url_for('driver.recharge_balance') }}"
         class="text-sm text-blue-600 hover:underline">Recargar</a>
    </div>

    <!-- ESTADO -->
    <div class="flex items-center gap-4 p-4 border rounded-lg">
      <p class="font-semibold">Mi estado:</p>

      {% if driver_profile.is_available %}
        <span class="px-3 py-1 bg-green-200 text-green-800 rounded-full font-semibold">
          Disponible
        </span>
      {% else %}
        <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full font-semibold">
          No disponible
        </span>
      {% endif %}

      <form action="{{ url_for('driver.toggle_availability') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-sm">
          Cambiar
        </button>
      </form>
    </div>
  </div>
</div>

<!-- ENTREGAS ACTIVAS -->
<h2 class="text-2xl font-bold text-gray-700 mb-6">Mis Entregas Activas</h2>

{% if orders %}
<div class="space-y-6">
{% for order in orders %}
<div class="bg-white rounded-lg shadow-xl overflow-hidden" x-data="{ detailsOpen: false }">

  <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
    <div>
      <h3 class="text-xl font-bold">
        Pedido #{{ order.id }} - {{ order.service.name|capitalize }}
      </h3>
      <p class="text-sm text-gray-500">
        Cliente: {{ order.user.customer_profile.first_name }}
      </p>
    </div>
    <span class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-200">
      {{ order.status }}
    </span>
  </div>

  <div class="p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="bg-gray-100 p-4 rounded">
        <strong>Recoger en:</strong>
        <p>{{ order.pickup_address }}</p>
      </div>
      <div class="bg-green-50 p-4 rounded">
        <strong>Entregar a:</strong>
        <p>{{ order.delivery_address }}</p>
      </div>
    </div>

    <button @click="detailsOpen = !detailsOpen"
            class="text-blue-600 font-semibold">
      Ver detalles
    </button>

    <div x-show="detailsOpen" class="mt-4">
      <ul class="list-disc ml-4">
        {% for item in order.items %}
          {% if item.paquete_envio %}
            <li>
              Paquete: {{ item.paquete_envio.tipo_paquete }}
              ({{ item.paquete_envio.peso_kg }}kg)
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  </div>

</div>
{% endfor %}
</div>
{% else %}
<p class="text-gray-500">No tienes entregas activas.</p>
{% endif %}

<!-- DISPONIBLES -->
{% if available_orders and not active_order %}
<div id="available-orders" class="mt-8 bg-white p-6 rounded shadow">
  <h3 class="font-bold mb-4">Domicilios disponibles</h3>

  {% for order in available_orders %}
  <div class="border p-4 mb-3 rounded">
    <p><strong>Pedido #{{ order.id }}</strong></p>
    <p>{{ order.address }}</p>

    <form method="POST"
          action="{{ url_for('driver.accept_order', order_id=order.id) }}"
          onsubmit="this.querySelector('button').disabled=true;">
      {{ form.hidden_tag() }}
      <button class="bg-green-600 text-white px-4 py-2 rounded">
        Aceptar pedido
      </button>
    </form>
  </div>
  {% endfor %}
</div>
{% endif %}

</div>

<!-- ðŸ”” SCRIPT ÃšNICO -->
<script>
let lastOrderId = null;

async function checkDriverNotifications() {
  try {
    const res = await fetch("/driver/notifications");
    const data = await res.json();

    if (!data.driver_available) return;
    if (!data.has_new) return;

    if (data.order_id !== lastOrderId) {
      document.getElementById("driverBell").classList.remove("hidden");
      const audio = document.getElementById("driverSound");
      audio.currentTime = 0;
      audio.play().catch(()=>{});
      lastOrderId = data.order_id;
    }
  } catch {}
}

setInterval(checkDriverNotifications, 10000);
</script>

{% endblock %}
