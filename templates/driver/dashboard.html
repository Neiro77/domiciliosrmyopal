{% extends 'base.html' %}
{% block title %}Dashboard de Conductor{% endblock %}
{% block content %}

<div class="container mx-auto px-4 py-8">

  <!-- üîî Campana de notificaci√≥n -->
  <div id="driverBell"
     class="relative cursor-pointer select-none hidden">
  üîî
	<span id="driverNotifCount"
        class="absolute -top-2 -right-2 bg-red-600 text-white
               text-xs font-bold px-2 py-0.5 rounded-full hidden">
		0
	</span>
  </div>

  <audio id="notifSound" preload="auto">
	<source src="{{ url_for('static', filename='sounds/alerta_virus.mp3') }}" type="audio/mpeg">
  </audio>


  <!-- Header -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">

      <div>
        <h1 class="text-3xl font-extrabold text-gray-800">
          Hola, {{ driver_profile.first_name }}
        </h1>
        <p class="text-gray-600">Aqu√≠ est√°n tus entregas asignadas.</p>
      </div>

      <div class="text-center">
        <p class="text-sm text-gray-500">Saldo Actual</p>
        <p class="text-2xl font-bold text-green-600">
          ${{ "%.2f"|format(driver_profile.saldo_cuenta) }}
        </p>
        <a href="{{ url_for('driver.recharge_balance') }}"
           class="text-sm text-blue-600 hover:underline">
          Recargar
        </a>
      </div>

      <!-- Estado -->
      <div class="flex items-center gap-4 p-4 border rounded-lg">
        <p class="font-semibold">Mi estado:</p>

        {% if driver_profile.is_available %}
          <span class="px-3 py-1 bg-green-200 text-green-800 rounded-full font-semibold">
            Disponible
          </span>
        {% else %}
          <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full font-semibold">
            No Disponible
          </span>
        {% endif %}

        <form method="POST" action="{{ url_for('driver.toggle_availability') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg">
            Cambiar
          </button>
        </form>
      </div>

    </div>
  </div>

  <!-- ===================== -->
  <!-- PEDIDOS ACTIVOS -->
  <!-- ===================== -->
  <h2 class="text-2xl font-bold text-gray-700 mb-6">Mis Entregas Activas</h2>

  {% if orders %}
    <div class="space-y-6">
      {% for order in orders %}
        <div class="bg-white rounded-lg shadow-xl overflow-hidden" x-data="{ open:false }">

          <div class="bg-gray-50 p-4 border-b flex justify-between">
            <div>
              <h3 class="text-xl font-bold">
                Pedido #{{ order.id }} ‚Äì
                <span class="text-blue-600">{{ order.service.name }}</span>
              </h3>
              <p class="text-sm text-gray-500">
                Cliente: {{ order.user.customer_profile.first_name }}
              </p>
            </div>

            <span class="px-3 py-1 rounded-full text-sm font-semibold
			{% if order.status == OrderStatus.ACCEPTED.value %}
				bg-blue-200 text-blue-800
			{% elif order.status == OrderStatus.PREPARING.value %}
				bg-yellow-200 text-yellow-800
			{% elif order.status == OrderStatus.OUT_FOR_DELIVERY.value %}
				bg-orange-200 text-orange-800
			{% else %}
				bg-gray-200 text-gray-800
			{% endif %}
			">
			  {{ order.status }}
			</span>
          </div>

          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="bg-gray-100 p-4 rounded">
                <strong>Recoger en:</strong>
                <p>{{ order.pickup_address or 'No especificada' }}</p>
              </div>
              <div class="bg-green-50 p-4 rounded">
                <strong>Entregar a:</strong>
                <p>{{ order.delivery_address }}</p>
              </div>
            </div>

            <!-- Detalles -->
            <button @click="open = !open"
                    class="text-blue-600 font-semibold w-full text-left">
              Ver detalles
            </button>

            <div x-show="open" class="mt-4">
              <ul class="list-disc ml-4">
                {% for item in order.items %}
                  {% if item.tipo_item == 'producto_comida' and item.product %}
                    <li>{{ item.quantity }} x {{ item.product.name }}</li>
                  {% elif item.tipo_item == 'paquete_envio' and item.paquete_envio %}
                    <li>
                      Paquete {{ item.paquete_envio.tipo_paquete }} ‚Äì
                      {{ item.paquete_envio.descripcion }}
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>

            <!-- Estados -->
            <!-- Estados -->
			<div class="mt-4">

			  {% if order.status in [
				  OrderStatus.ACCEPTED.value,
				  OrderStatus.PREPARING.value
			  ] %}

				<form method="POST"
					  action="{{ url_for('driver.update_delivery_status', order_id=order.id) }}">
				  {{ form.hidden_tag() }}
				  <input type="hidden" name="new_status"
						 value="{{ OrderStatus.OUT_FOR_DELIVERY.value }}">
				  <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
					Salir a entregar
				  </button>
				</form>

			  {% elif order.status == OrderStatus.OUT_FOR_DELIVERY.value %}

				<form method="POST"
					  action="{{ url_for('driver.update_delivery_status', order_id=order.id) }}">
				  {{ form.hidden_tag() }}
				  <input type="hidden" name="new_status"
						 value="{{ OrderStatus.DELIVERED.value }}">
				  <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
					Marcar entregado
				  </button>
				</form>

			  {% endif %}

			</div>

          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500">No tienes pedidos activos.</p>
  {% endif %}

  <!-- ===================== -->
  <!-- DOMICILIOS DISPONIBLES -->
  <!-- ===================== -->
  {% if driver_profile.is_available and not active_order and available_orders %}
    <div id="available-orders" class="mt-8 bg-white p-6 rounded shadow">
      <h3 class="text-xl font-bold mb-4">Domicilios disponibles</h3>

      {% for order in available_orders %}
        <div class="border p-4 rounded mb-3">
          <p><strong>Pedido #{{ order.id }}</strong></p>
          <p>{{ order.address }}</p>

          <form method="POST"
                action="{{ url_for('driver.accept_order', order_id=order.id) }}">
            {{ form.hidden_tag() }}
            <button class="bg-green-600 text-white px-4 py-2 rounded">
              Aceptar pedido
            </button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>

<!-- üîî Polling -->

<script>
let lastHasNew = false;

async function checkDriverNotifications() {
  try {
    const res = await fetch('/driver/notifications');
    if (!res.ok) return;

    const data = await res.json();

    const bell = document.getElementById('driverBell');
    const count = document.getElementById('driverNotifCount');
    const sound = document.getElementById('notifSound');

    // üîí Driver NO disponible ‚Üí ocultar todo
    if (!data.is_available) {
      bell.classList.add('bell-active');
      count.classList.remove('hidden');
      lastHasNew = false;
      return;
    }

    // Driver disponible ‚Üí mostrar campana
    bell.classList.remove('hidden');

    if (data.has_new) {
      count.textContent = data.count || 1;
      count.classList.remove('hidden');

      // üîî sonar SOLO si es nuevo
      if (!lastHasNew) {
        sound.play().catch(() => {});
      }
      lastHasNew = true;
    } else {
      count.classList.add('hidden');
      lastHasNew = false;
    }

  } catch (e) {
    console.warn('Error notifications', e);
  }
}

// polling cada 10s

checkDriverNotifications();
</script>
<script>
let lastHasNew = false;

async function checkDriverNotifications() {
  try {
    const res = await fetch('/driver/notifications');
    if (!res.ok) return;

    const data = await res.json();

    const bell = document.getElementById('driverBell');
    const count = document.getElementById('driverNotifCount');
    const sound = document.getElementById('notifSound');

    // üîí Driver NO disponible ‚Üí ocultar campana
    if (!data.is_available) {
      bell.classList.add('hidden');
      count.classList.add('hidden');
      lastHasNew = false;
      return;
    }

    // Driver disponible
    bell.classList.remove('hidden');

    if (data.has_new) {
      count.textContent = data.count || 1;
      count.classList.remove('hidden');

      // üîî sonar SOLO cuando aparece uno nuevo
      if (!lastHasNew) {
        sound.currentTime = 0;
        sound.play().catch(() => {});
      }
      lastHasNew = true;
    } else {
      count.classList.add('hidden');
      lastHasNew = false;
    }

  } catch (e) {
    console.warn('Error notifications', e);
  }
}

// ‚è±Ô∏è polling √∫nico
checkDriverNotifications();
setInterval(checkDriverNotifications, 8000);
</script>

{% endblock %}
