{% extends 'base.html' %}

{% block title %}Enviar Paquete{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl" x-data="packageForm">

    <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Enviar un Paquete</h1>

    <div class="bg-white rounded-lg shadow-xl p-8 mb-8">
        <p class="text-gray-700 text-lg mb-6 text-center">
            Ingresa todos los detalles posibles para ser precisos en tu envÃ­o.
        </p>
        
        <form method="POST" action="{{ url_for('customer.create_package') }}" @submit.prevent="validateAndSubmit($event)"> 
		{{ form.csrf_token }}

            {{ form.csrf_token }}

            {% if form.errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <strong class="font-bold">Â¡Error!</strong>
                    <span class="block sm:inline">Por favor, corrige los siguientes errores:</span>
                    <ul class="mt-2 list-disc list-inside">
                    {% for field, errors in form.errors.items() %}
                        {% if field != 'csrf_token' %}
                            <li><strong>{{ form[field].label.text }}:</strong> {{ errors | join(', ') }}</li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                </div>
            {% endif %}
			
			<!-- DESCRIPCIÃ“N -->
			<div>
				<label class="block text-sm font-semibold text-gray-700 mb-1">
					Â¿QuÃ© estÃ¡s enviando?
				</label>
				{{ form.descripcion(
					class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none",
					placeholder="Ej: Documentos, encomienda, regalo, etc."
				) }}
				{% for error in form.descripcion.errors %}
					<p class="text-red-500 text-sm mt-1">{{ error }}</p>
				{% endfor %}
			</div>

			<!-- NOMBRE RECEPTOR -->
			<div class="form-group">
				<label for="nombre_quien_recibe">Nombre de quien recibe</label>
				{{ form.nombre_quien_recibe(class="form-control", placeholder="Ej: Juan PÃ©rez") }}
				{% if form.nombre_quien_recibe.errors %}
					<small class="text-danger">
						{{ form.nombre_quien_recibe.errors[0] }}
					</small>
				{% endif %}
			</div>

			<!-- TELÃ‰FONO RECEPTOR -->
			<div class="form-group">
				<label for="telefono_quien_recibe">TelÃ©fono de quien recibe</label>
				{{ form.telefono_quien_recibe(class="form-control", placeholder="Ej: 3001234567") }}
				{% if form.telefono_quien_recibe.errors %}
					<small class="text-danger">
						{{ form.telefono_quien_recibe.errors[0] }}
					</small>
				{% endif %}
			</div>
	

            <div class="mt-8">
				
				<button type="submit" 
						class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold text-lg shadow-md">
					<i class="fas fa-cart-plus mr-2"></i> ðŸšš Solicitar EnvÃ­o
				</button>
			</div>
        </form>
    </div>

    <div class="mt-8 text-center">
        <a href="{{ url_for('customer.dashboard') }}" class="text-blue-600 hover:underline font-semibold">
            <i class="fas fa-arrow-left mr-2"></i> Volver al Dashboard
        </a>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('packageForm', () => ({
        packageType: '',
        packageDescription: '',
        weightKg: 0,
        dimensionsCm: '',
        declaredValue: 0,
        specialInstructions: '',
        packagePrice: 0.00,

        init() {
            // Restaurar valores si hay error en formulario
            this.packageType = '{{ form.tipo_paquete.data or "" }}';
            this.packageDescription = '{{ form.descripcion.data or "" }}';
            this.weightKg = parseFloat('{{ form.peso_kg.data or 0 }}');
            this.dimensionsCm = '{{ form.dimensiones_cm.data or "" }}';
            this.declaredValue = parseFloat('{{ form.valor_declarado.data or 0 }}');
            this.specialInstructions = '{{ form.instrucciones_especiales.data or "" }}';
            this.packagePrice = parseFloat('{{ form.precio_calculado.data or 0 }}');

            this.calculatePrice();

            this.$watch('packageType', () => this.calculatePrice());
            this.$watch('weightKg', () => this.calculatePrice());
            this.$watch('declaredValue', () => this.calculatePrice());
        },

        calculatePrice() {
            let basePrice = 5000;
            let weightCost = (this.weightKg || 0) * 1000;
            let valueCost = (this.declaredValue || 0) * 0.01;

            switch (this.packageType) {
                case 'documento':
                    basePrice += 1000;
                    break;
                case 'caja_pequena':
                    basePrice += 2000;
                    break;
                case 'caja_mediana':
                    basePrice += 4000;
                    break;
                case 'caja_grande':
                    basePrice += 8000;
                    break;
                case 'otro':
                    basePrice += 5000;
                    break;
            }

            const randomFactor = Math.random() * 500;
            this.packagePrice = Math.max(basePrice + weightCost + valueCost + randomFactor, 5000);
        },

        validateAndSubmit(event) {
            if (!this.packagePrice || this.packagePrice <= 0 || isNaN(this.packagePrice)) {
                alert("El precio calculado no es vÃ¡lido. Intenta de nuevo.");
                return;
            }

            const hiddenInput = event.target.querySelector('input[name="precio_calculado"]');
            if (hiddenInput) hiddenInput.value = this.packagePrice.toFixed(2);

            event.target.submit();
        }
    }));
});
</script>

{% endblock %}
