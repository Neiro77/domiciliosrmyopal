{% extends 'base.html' %}

{% block title %}{{ business.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-xl overflow-hidden mb-8">
        <div class="relative">
            <img src="{{ business.logo or 'https://placehold.co/800x300/cccccc/333333?text=Logo+Negocio' }}" 
                 alt="Logo de {{ business.name }}" 
                 class="w-full h-64 object-cover object-center"
                 onerror="this.onerror=null;this.src='https://placehold.co/800x300/cccccc/333333?text=Logo+Negocio';">
            <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent opacity-70"></div>
            <div class="absolute bottom-0 left-0 p-6 text-white">
                <h1 class="text-4xl font-extrabold mb-2">{{ business.name }}</h1>
                <p class="text-lg mb-2">{{ business.description }}</p>
                <div class="flex items-center text-sm">
                    <i class="fas fa-star mr-2 text-yellow-400"></i>
                    <span>{{ "%.1f" | format(business.rating) }} ({{ business.reviews_count }} reseñas)</span>
                    <span class="ml-4"><i class="fas fa-phone mr-2"></i> {{ business.phone_number }}</span>
                    <span class="ml-4"><i class="fas fa-map-marker-alt mr-2"></i> {{ business.address }}</span>
                </div>
                <div class="mt-3 text-lg font-bold">
                    Estado: <span class="font-bold 
                            {% if business.status == 'Abierto' %}text-green-400
                            {% elif business.status == 'Cerrado' %}text-red-400
                            {% else %}text-yellow-400{% endif %}">
                            {{ business.status }}
                            </span>
                </div>
            </div>
        </div>
        <div class="p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Menú</h2>

            {% if categories %}
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Categorías:</h3>
                <div class="flex flex-wrap gap-3">
                    {% for category in categories %}
                        <a href="#category-{{ category.id }}" 
                           class="bg-blue-100 text-blue-800 text-sm font-medium px-4 py-2 rounded-full 
                                  hover:bg-blue-200 transition duration-200 ease-in-out">
                            {{ category.name }}
                        </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if products %}
                {% set current_category = None %}
                {% for product in products %}
                    {% if product.category and product.category.name != current_category %}
                        {% set current_category = product.category.name %}
                        <h3 id="category-{{ product.category.id }}" class="text-2xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">{{ current_category }}</h3>
                    {% elif not product.category and current_category != "Sin Categoría" %}
                        {% set current_category = "Sin Categoría" %}
                        <h3 id="category-no-category" class="text-2xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">Sin Categoría</h3>
                    {% endif %}

                    <!-- --- TARJETA DE PRODUCTO MEJORADA --- -->
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg shadow-sm mb-4 transition duration-200 ease-in-out hover:bg-gray-100"
                         x-data="{ quantity: 1 }"> {# <-- Cada producto tiene su propia cantidad local #}
                        
                        <img src="{{ product.image_url or 'https://placehold.co/100x100/eeeeee/333333?text=Producto' }}" 
                             alt="Imagen de {{ product.name }}" 
                             class="w-24 h-24 object-cover rounded-md mr-4 flex-shrink-0">
                        
                        <div class="flex-grow">
                            <h4 class="text-xl font-semibold text-gray-800">{{ product.name }}</h4>
                            <p class="text-gray-600 text-sm mt-1">{{ product.description | truncate(100) }}</p>
                            <p class="text-blue-600 font-bold text-lg mt-2">${{ "%.2f" | format(product.price) }}</p>
                        </div>
                        
                        <div class="flex-shrink-0 ml-4 flex flex-col items-center gap-2">
                            <!-- Selector de Cantidad -->
                            <div class="flex items-center border border-gray-300 rounded-lg">
                                <button @click="quantity = Math.max(1, quantity - 1)" 
                                        class="px-3 py-1 text-lg font-bold text-gray-600 hover:bg-gray-200 rounded-l-lg">-</button>
                                <span x-text="quantity" class="px-4 py-1 font-semibold text-gray-800"></span>
                                <button @click="quantity++" 
                                        class="px-3 py-1 text-lg font-bold text-gray-600 hover:bg-gray-200 rounded-r-lg">+</button>
                            </div>
                            
                            <!-- Botón para Añadir la cantidad seleccionada -->
                            <button @click='Alpine.store("cart").addItem({{ product.id }}, {{ product.name | tojson }}, {{ product.price }}, {{ business.id }}, {{ business.name | tojson }}, quantity)'
                                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                                <i class="fas fa-plus mr-1"></i> Añadir
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
				<p class="text-center text-gray-600 text-lg">Este negocio no tiene productos disponibles en este momento.</p>
            {% endif %}
        </div>
    </div>
    <div class="mt-8 text-center">
        <a href="{{ url_for('customer.list_businesses') }}" class="text-blue-600 hover:underline font-semibold">
            <i class="fas fa-arrow-left mr-2"></i> Volver a la lista de negocios
        </a>
    </div>
</div>
{% endblock %}
